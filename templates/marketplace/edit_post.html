{% extends "base.html" %}
{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ{% endblock title %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="mmo-card p-4">
            {% if post.author == user %}
                <h2 class="text-center mb-4">üõ†Ô∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
                
                <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã -->
                {% if media_files %}
                <div class="mb-4">
                    <h5>üìÅ –¢–µ–∫—É—â–∏–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã:</h5>
                    <div class="row">
                        {% for media in media_files %}
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="media-item text-center">
                                {% if media.file %}
                                    {% if media.file.name|lower|slice:"-4:" in '.jpg,.jpeg,.png,.gif,.webp,.bmp' %}
                                        <img src="{{ media.file.url }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {{ forloop.counter }}" 
                                             class="img-fluid rounded mb-2" 
                                             style="max-height: 150px; width: auto; object-fit: contain;">
                                    {% else %}
                                        <div class="bg-dark rounded p-3 text-center">
                                            <span class="text-muted">üé• –í–∏–¥–µ–æ/–§–∞–π–ª</span>
                                            <br>
                                            <a href="{{ media.file.url }}" class="text-warning mt-2" download>üì• –°–∫–∞—á–∞—Ç—å</a>
                                        </div>
                                    {% endif %}
                                {% endif %}
                                <div class="mt-2">
                                    <a href="{% url 'delete_media' media.id %}" class="btn btn-danger btn-sm" 
                                       onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        ‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_title" class="form-label">üìå –ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                                {{ form.title }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_category" class="form-label">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                                {{ form.category }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_content" class="form-label">üìñ –û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        {{ form.content }}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_price" class="form-label">üí∞ –¶–µ–Ω–∞ (–≤ –∑–æ–ª–æ—Ç–µ):</label>
                                {{ form.price }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_is_active" class="form-label">üìä –°—Ç–∞—Ç—É—Å:</label>
                                <div class="form-check form-switch mt-2">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="id_is_active">
                                        –ê–∫—Ç–∏–≤–Ω–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_media_files" class="form-label">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã:</label>
                        {{ form.media_files }}
                        <div class="form-text">{{ form.media_files.help_text }}</div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-warning flex-fill">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                        <a href="{% url 'post_detail' post.slug %}" class="btn btn-secondary">üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>
                        <a href="{% url 'my_posts' %}" class="btn btn-outline-secondary">‚ùå –û—Ç–º–µ–Ω–∞</a>
                    </div>
                </form>
            {% else %}
                <div class="text-center">
                    <h1>üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h1>
                    <p>–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç—ã, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏!</p>
                    <a href="{% url 'post_list' %}" class="btn btn-warning">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º</a>
                </div>
            {% endif %}    
        </div>
    </div>
</div>

<style>
.mmo-card {
    background: rgba(30, 55, 153, 0.8);
    border: 2px solid #4a69bd;
    border-radius: 10px;
}
.form-control, .form-select {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid #4a69bd;
    color: white;
}
.form-control:focus, .form-select:focus {
    background: rgba(255, 255, 255, 0.2);
    border-color: #f6b93b;
    color: white;
}
.form-check-input:checked {
    background-color: #f6b93b;
    border-color: #f6b93b;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // AJAX —É–¥–∞–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤
    const deleteButtons = document.querySelectorAll('a[href*="delete_media"]');
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')) {
                const url = this.getAttribute('href');
                
                fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.closest('.col-md-3').remove();
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å
                        const mediaItems = document.querySelectorAll('.media-item');
                        if (mediaItems.length === 0) {
                            const mediaSection = document.querySelector('.mb-4');
                            if (mediaSection) {
                                mediaSection.innerHTML = '<p>üì≠ –ú–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç</p>';
                            }
                        }
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
                });
            }
        });
    });
});
</script>
{% endblock content %}