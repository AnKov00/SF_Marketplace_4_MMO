{% extends 'base.html' %}

{% block title %}–í—Å–µ —Ç–æ–≤–∞—Ä—ã - MMO Marketplace{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <h1 class="display-4">‚öîÔ∏è MMO Marketplace</h1>
    <p class="lead">–¢–æ—Ä–≥–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞ –¥–ª—è –Ω–∞—Å—Ç–æ—è—â–∏—Ö –≥–µ—Ä–æ–µ–≤</p>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filter-section mb-4">
    <form method="get" class="row g-3">
        <div class="col-md-3">
            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select name="category" class="form-select">
                <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                {% for category in categories %}
                    <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"i" %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">–¢–∏–ø</label>
            <select name="type_post" class="form-select">
                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                <option value="wts" {% if request.GET.type_post == "wts" %}selected{% endif %}>–ü—Ä–æ–¥–∞–∂–∞</option>
                <option value="wtb" {% if request.GET.type_post == "wtb" %}selected{% endif %}>–ü–æ–∫—É–ø–∫–∞</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">–¶–µ–Ω–∞ –æ—Ç</label>
            <input type="number" name="price_min" class="form-control" placeholder="0" value="{{ request.GET.price_min }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">–¶–µ–Ω–∞ –¥–æ</label>
            <input type="number" name="price_max" class="form-control" placeholder="999999" value="{{ request.GET.price_max }}">
        </div>
        <div class="col-12">
            <button type="submit" class="btn btn-warning">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
            <a href="?" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
        </div>
    </form>
</div>

<!-- –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π -->
{% if not posts %}
    <div class="text-center mt-5">
        <h2>üì≠ –ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h2>
    </div>
{% else %}
    <div class="row">
        {% for post in posts %}
            {% if post.is_active %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="mmo-card p-3 h-100 d-flex flex-column">
                    <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                    {% with post.media.all as media_files %}
                        {% if media_files %}
                            {% with media_files.first as first_media %}
                                {% if first_media.file and first_media.file.name|lower|slice:"-4:" in '.jpg,.jpeg,.png,.gif,.webp,.bmp' %}
                                    <img src="{{ first_media.file.url }}" alt="{{ post.title }}" 
                                        class="post-image mb-3 rounded">
                                {% else %}
                                    <div class="post-image bg-dark d-flex align-items-center justify-content-center mb-3 rounded">
                                        <span class="text-muted">üé• –í–∏–¥–µ–æ/–§–∞–π–ª</span>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <div class="post-image bg-dark d-flex align-items-center justify-content-center mb-3 rounded">
                                <span class="text-muted">üñºÔ∏è –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                            </div>
                        {% endif %}
                    {% endwith %}

                    <!-- –û—Å—Ç–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                    <h5>
                        <a href="{% url 'post_detail' post.slug %}" class="text-white text-decoration-none">
                            {{ post.title }}
                        </a>
                    </h5>
                    <span class="category-badge mb-2">{{ post.category.name }}</span>

                    <div class="mt-auto">
                        <div class="mb-2">
                            <small class="text-light">üë§ {{ post.author.username }}</small>
                            <br>
                            <small class="{% if post.type_post == 'wts' %}text-success{% else %}text-info{% endif %}">
                                {% if post.type_post == 'wts' %}üí∞ –ü—Ä–æ–¥–∞–∂–∞{% else %}üõí –ü–æ–∫—É–ø–∫–∞{% endif %}
                            </small>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <span class="price-tag">{{ post.price }} –∑–æ–ª–æ—Ç–∞</span>
                            <small class="text-muted">{{ post.updated_at|date:"d.m.Y" }}</small>
                        </div>
                        {% if post.author == user%}
                        <a href="{% url 'edit_post' post.slug %}" class="btn btn-outline-warning btn-sm w-100 mt-2">
                            üîç –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </a>
                        {% else %}
                        <a href="{% url 'post_detail' post.slug %}" class="btn btn-outline-warning btn-sm w-100 mt-2">
                            üîç –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
{% endif %}

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if page_obj.has_other_pages %}
<nav aria-label="Page navigation" class="mt-5">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">¬´¬´</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">¬´</a>
            </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">¬ª</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">¬ª¬ª</a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<style>
.filter-section {
    background: rgba(30, 55, 153, 0.9);
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
}
.post-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
}
.category-badge {
    background: #e55039;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    display: inline-block;
}
.price-tag {
    background: #f6b93b;
    color: #2f3640;
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
}
.media-container {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
}

.post-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
}

/* –î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã - –±–æ–ª—å—à–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
.media-item img {
    max-width: 100%;
    height: auto;
    max-height: 300px;
    object-fit: contain;
    transition: transform 0.3s ease;
}

.media-item img:hover {
    transform: scale(1.05);
}
</style>
{% endblock %}